<!DOCTYPE html>
<style>

    .state-borders {
        fill: none;
        stroke: #fff;
        stroke-width: 0.5px;
        stroke-linejoin: round;
        stroke-linecap: round;
        pointer-events: none;
    }
    
    .track{
        stroke: #000;
        stroke-opacity: 0.3;
        stroke-width: 10px;
    }
    
    .track-inset {
        stroke: black;
        stroke-width: 8px;
    }
    .track-overlay {
        pointer-events: stroke;
        stroke-width: 50px;
        stroke: transparent;
        cursor: crosshair;
    }
    div.tooltip {	
        position: absolute;			
        text-align: center;								
        padding: 2px;				
        font: 12px sans-serif;		
        background: lightsteelblue;	
        border: 0px;		
        border-radius: 8px;			
        pointer-events: none;			
    }

</style>
<body></body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script>

var width = 960,
    height = 600;
    
var div = d3.select("body").append("div")	
    .attr("class", "tooltip")				
    .style("opacity", 0);
    
var svg = d3.select("body")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .attr("fill", "grey");
    
var projection = d3.geoAlbersUsa()
                    .translate([width/2, height/2])
                    .scale([1000]);

var path = d3.geoPath()
                .projection(projection);

d3.json("us-states.json", function(error, us) {
    svg.selectAll("path")
        .data(us.features)
        .enter()
        .append("path")
        .attr("d", path)
        .style("stroke", "#fff");
});

d3.csv("data.csv", function(data){
    var maxYear = d3.max(data, function(d){
        return d.Year;
    });
    
    var minYear = d3.min(data, function(d){
        return d.Year;
    });
    
    svg.selectAll("circle")
        .data(data)
        .enter()
        .append("circle")
        .attr("cx", function(d){
            return projection([d.longitude, d.latitude])[0];
        })
        .attr("cy", function(d){
            return projection([d.longitude, d.latitude])[1];
        })
        .attr("r", function(d){
            return d.Fatalities/3
        })
        .style("fill", "red")
        .attr("class", "shooting-circles")
        .on("mouseover", function(d) {		
            div.transition()		
                .duration(200)		
                .style("opacity", .9);		
            div	.html(d.Case)	
                .style("left", (d3.event.pageX) + "px")		
                .style("top", (d3.event.pageY - 28) + "px");	
            })					
        .on("mouseout", function(d) {		
            div.transition()		
                .duration(500)		
                .style("opacity", 0);	
        });
    
    var x = d3.scaleLinear()
            .domain([minYear, maxYear])
            .range([0,width*3/4])
            .clamp(true);

    var slider = svg.append("g")
        .attr("class", "slider")
        .attr("transform", "translate(50,20)");

    slider.append("line")
            .attr("class", "track")
            .attr("x1", x.range()[0])
            .attr("x2", x.range()[1])
            .select(function(){ 
                return this.parentNode.appendChild(this.cloneNode(true)); 
            })
            .attr("class", "track-inset")
            .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
            .attr("class", "track-overlay")
            .call(d3.drag()
                    .on("drag", function(){
        
                        var yearSelected = Math.round(x.invert(d3.event.x));
                        moveCircle(yearSelected);
                        var yearOf = data.filter(function(d){
                            if (d.Year == yearSelected){
                                return d;
                            }
                        });
                        d3.select("svg")
                            .selectAll(".shooting-circles")
                            .remove();
                        svg.selectAll(".shooting-circles")
                            .data(yearOf)
                            .enter()
                            .append("circle")
                            .attr("cx", function(d){
                                return projection([d.longitude, d.latitude])[0];
                            })
                            .attr("cy", function(d){
                                return projection([d.longitude, d.latitude])[1];
                            })
                            .attr("r", function(d){
                                if (d.Year == yearSelected){
                                    return d.Fatalities;
                                }
                                else{
                                    return 0;
                                }
                            })
                            .attr("class", "shooting-circles")
                            .style("fill", "red")
                            .on("mouseover", function(d) {		
                                div.transition()		
                                    .duration(200)		
                                    .style("opacity", .9);		
                                div	.html(d.Case)	
                                    .style("left", (d3.event.pageX) + "px")		
                                    .style("top", (d3.event.pageY - 28) + "px");	
                                })					
                            .on("mouseout", function(d) {		
                                div.transition()		
                                    .duration(500)		
                                    .style("opacity", 0);	
                            });
                        
            }));


    slider.insert("g", ".track-overlay")
            .attr("class", "ticks")
            .attr("transform", "translate(0,18)")
            .selectAll("text")
            .data(x.ticks(20))
            .enter()
            .append("text")
            .attr("x", x)
            .attr("text-anchor", "middle")
            .text(function(d){return d });

    var handle = slider.insert("circle", ".track-overlay")
                        .attr("class", "handle")
                        .attr("r", 9);
    
    function moveCircle(h){
        handle.attr("cx", x(h));
    }
});

</script>