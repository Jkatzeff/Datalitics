<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>D3 Map</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-queue.v3.min.js"></script>
</head>
<style>
    .background{
        fill: white;
    }
    .map-layer {
/*        fill: black;*/
        stroke: black;
    }
    div.tooltip {	
        position: absolute;			
        text-align: center;			
        width: 150px;					
        height: 50px;					
        padding: 1px;				
        font: 20px sans-serif;		
        background: lightsteelblue;			
        border-radius: 8px;			
        pointer-events: none;
        opacity: 0;
    }
/* bar style class */
    div.bar{
        position: absolute;
        font: 10px sans-serif;
        padding: 1px;
        background: pink;
        border-radius: 3px;
        pointer-events: none;
        opacity: 0;
    }
    circle{
        fill: orange;
    }
    
</style>
<body>
</body>
<script>
    //base variable values for the represnentation bars
    var wbar = d3.select("body")
                .append("div")
                .attr("class", "bar");
    var bbar = d3.select("body")
                .append("div")
                .attr("class", "bar");
    var abar = d3.select("body")
                .append("div")
                .attr("class", "bar");
    var natbar = d3.select("body")
                .append("div")
                .attr("class", "bar");
    var chbar = d3.select("body")
                .append("div")
                .attr("class", "bar");
    var jpbar = d3.select("body")
                .append("div")
                .attr("class", "bar");
    var fpbar = d3.select("body")
                .append("div")
                .attr("class", "bar");
    var korbar = d3.select("body")
                .append("div")
                .attr("class", "bar");
    var pacbar = d3.select("body")
                .append("div")
                .attr("class", "bar");
    var othbar = d3.select("body")
                .append("div")
                .attr("class", "bar");
    var twobar = d3.select("body")
                .append("div")
                .attr("class", "bar");
                
    
    var div = d3.select("body")
                .append("div")
                .attr("class", "tooltip");
    
    var width = 800,
        height = 800;
    
    var svg = d3.select("body")
                .append("svg")
                .attr("width", width)
                .attr("height", height);
    svg.append("rect")
        .attr("class", "background")
        .attr("width", width)
        .attr("height", height);
    
    
    var g = svg.append("g");
    
    var mapLayer = g.append("g")
                    .classed("map-layer", true);
    
    var q = d3.queue()
    q.defer(d3.json, "california-counties.json")
        .defer(d3.csv, "nhgis0002_csv/nhgis0002_ts_nominal_county.csv")
        .await(ready);
    
    function ready(error, ca, data){
        ca['features'].forEach(function(d1){
            data.slice(203, 261).forEach(function(d2){
                if (d1.properties.name == d2["COUNTY"].substring(0, d2["COUNTY"].lastIndexOf(" "))){
                    d1.properties["1970"] = {}
                    d1.properties["1970"]["whites"] = d2['B08AA1970'];
                    d1.properties["1970"]["blacks"] = d2['B08AB1970'];
                    d1.properties["1970"]["american-indian-and-alaska-natives-tribes"] = d2['B08AC1970'];
                    d1.properties["1970"]["asian-japanese"] = d2['B08AD1970'];
                    d1.properties["1970"]["asian-chinese"] = d2['B08AE1970'];
                    d1.properties["1970"]["asian-filipino"] = d2['B08AF1970'];
                    d1.properties["1970"]["asian-korean"] = d2['B08AG1970'];
                    d1.properties["1970"]["native-hawaiian-and-pacific-islanders"] = d2['B08AH1970'];
                    d1.properties["1970"]["other-single-race"] = d2['B08AI1970'];
                    d1.properties["1970"]["two-or-more-races"] = d2['B08AJ2000'];

                    d1.properties["1980"] = {}
                    d1.properties["1980"]["whites"] = d2['B08AA1980'];
                    d1.properties["1980"]["blacks"] = d2['B08AB1980'];
                    d1.properties["1980"]["american-indian-and-alaska-natives-tribes"] = d2['B08AC1980'];
                    d1.properties["1980"]["asian-japanese"] = d2['B08AD1980'];
                    d1.properties["1980"]["asian-chinese"] = d2['B08AE1980'];
                    d1.properties["1980"]["asian-filipino"] = d2['B08AF1980'];
                    d1.properties["1980"]["asian-korean"] = d2['B08AG1980'];
                    d1.properties["1980"]["native-hawaiian-and-pacific-islanders"] = d2['B08AH1980'];
                    d1.properties["1980"]["other-single-race"] = d2['B08AI1980'];
                    d1.properties["1980"]["two-or-more-races"] = d2['B08AJ2000'];

                    d1.properties["1990"] = {}
                    d1.properties["1990"]["whites"] = d2['B08AA1990'];
                    d1.properties["1990"]["blacks"] = d2['B08AB1990'];
                    d1.properties["1990"]["american-indian-and-alaska-natives-tribes"] = d2['B08AC1990'];
                    d1.properties["1990"]["asian-japanese"] = d2['B08AD1990'];
                    d1.properties["1990"]["asian-chinese"] = d2['B08AE1990'];
                    d1.properties["1990"]["asian-filipino"] = d2['B08AF1990'];
                    d1.properties["1990"]["asian-korean"] = d2['B08AG1990'];
                    d1.properties["1990"]["native-hawaiian-and-pacific-islanders"] = d2['B08AH1990'];
                    d1.properties["1990"]["other-single-race"] = d2['B08AI1990'];
                    d1.properties["1990"]["two-or-more-races"] = d2['B08AJ2000'];

                    d1.properties["2000"] = {}
                    d1.properties["2000"]["whites"] = d2['B08AA2000'];
                    d1.properties["2000"]["blacks"] = d2['B08AB2000'];
                    d1.properties["2000"]["american-indian-and-alaska-natives-tribes"] = d2['B08AC2000'];
                    d1.properties["2000"]["asian-japanese"] = d2['B08AD2000'];
                    d1.properties["2000"]["asian-chinese"] = d2['B08AE2000'];
                    d1.properties["2000"]["asian-filipino"] = d2['B08AF2000'];
                    d1.properties["2000"]["asian-korean"] = d2['B08AG2000'];
                    d1.properties["2000"]["native-hawaiian-and-pacific-islanders"] = d2['B08AH2000'];
                    d1.properties["2000"]["other-single-race"] = d2['B08AI2000'];
                    d1.properties["2000"]["two-or-more-races"] = d2['B08AJ2000'];

                    d1.properties["2010"] = {}
                    d1.properties["2010"]["whites"] = d2['B08AA2010'];
                    d1.properties["2010"]["blacks"] = d2['B08AB2010'];
                    d1.properties["2010"]["american-indian-and-alaska-natives-tribes"] = d2['B08AC2010'];
                    d1.properties["2010"]["asian-japanese"] = d2['B08AD2010'];
                    d1.properties["2010"]["asian-chinese"] = d2['B08AE2010'];
                    d1.properties["2010"]["asian-filipino"] = d2['B08AF2010'];
                    d1.properties["2010"]["asian-korean"] = d2['B08AG2010'];
                    d1.properties["2010"]["native-hawaiian-and-pacific-islanders"] = d2['B08AH2010'];
                    d1.properties["2010"]["other-single-race"] = d2['B08AI2010'];
                    d1.properties["2010"]["two-or-more-races"] = d2['B08AJ2010'];
                }
            })
        });
        
        console.log(ca.features);
        
        var center = d3.geoCentroid(ca);

        var projection = d3.geoMercator()
                        .scale(2000)
                        .center(center)
                        .translate([width/2, height/2]);
        
        var path = d3.geoPath()
                    .projection(projection);
        
        mapLayer.selectAll("path")
                .data(ca.features)
                .enter()
                .append("path")
                .attr("d", path)
                .attr('vector-effect', 'non-scaling-stroke')
                .style("fill", "grey")
    //            .on("click", mouseClick);
                .on("click",gravityCircles);
        
        //demographic cirle representations popup and pull together
        var totalNodes = 11;
        var demYear = "2010";
        
        //range variable for where circles attrac
        var xScale = d3.scaleLinear().domain([0, 1]).range([0, 600]);
        var nodes = d3.range(totalNodes).map(function(d) {
            return {
                radius: Math.random() * 25,
                value: Math.random()
                   }
        })
        
        function gravityCircles(d){
            
            var simulation = d3.forceSimulation(nodes)
                .force('charge', d3.forceManyBody().strength(5))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('x', d3.forceX().x(function(d) {
                    return xScale(d.value);
                }))
                .force('collision', d3.forceCollide().radius(function(d) {
                    return d.radius
                }))
                .on('tick',ticked);
            console.log("gravity circles called");
        }
        
        //updates positions on every tick
        function ticked(){
            var u = d3.select('svg')
                .selectAll('circle')
                .data(nodes)

            u.enter()
                .append('circle')
                .attr('r', function(d) {
                    return d.radius
                })
                .merge(u)
                .attr('cx', function(d) {
                    return d.x
                })
                .attr('cy', function(d) {
                    return d.y
                })
            u.exit().remove()
        }
        
        //function to get the popups to scale to demo size
        function scaleCircle(stat, circ){
            console.log("scalecircle called");
        }
    
        
        
        //this function pops up the demographics upon clicking a county
        function mouseClick(d){
            div.html(d.properties['name'] + "<br />" + d.properties["2010"]["whites"])
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY) + "px")
                            .style("opacity", 100);
            //white bar popup
            wbar.html("W")
                            .style("left", (d3.event.pageX) + "px")
                            .style("bottom", "-100%")
                            .style("opacity", 50)
                            .style("width", 20 +"px")
                            .style("height",
                                  Math.floor(
                                    d.properties["2010"]["whites"] / 1000) + "px");
            //black bar popup
            bbar.html("B")
                            .style("left", (d3.event.pageX) + 30 + "px")
                            .style("bottom", "-100%")
                            .style("opacity", 50)
                            .style("width", 20 +"px")
                            .style("height",
                                  Math.floor(
                                    d.properties["2010"]["blacks"] / 1000) + "px");
            //american native
            natbar.html("NAT")
                            .style("left", (d3.event.pageX) + 60 + "px")
                            .style("bottom", "-100%")
                            .style("opacity", 50)
                            .style("width", 20 +"px")
                            .style("height",
                                  Math.floor(
                                    d.properties["2010"]["american-indian-and-alaska-natives-tribes"] / 1000) + "px");
            //japanese
            jpbar.html("JP")
                            .style("left", (d3.event.pageX) + 90 + "px")
                            .style("bottom", "-100%")
                            .style("opacity", 50)
                            .style("width", 20 +"px")
                            .style("height",
                                  Math.floor(
                                    d.properties["2010"]["asian-japanese"] / 1000) + "px");
            //chinese
            chbar.html("CH")
                            .style("left", (d3.event.pageX) + 120 + "px")
                            .style("bottom", "-100%")
                            .style("opacity", 50)
                            .style("width", 20 +"px")
                            .style("height",
                                  Math.floor(
                                    d.properties["2010"]["asian-chinese"] / 1000) + "px");
            //filipino
            fpbar.html("FIL")
                            .style("left", (d3.event.pageX) + 150 + "px")
                            .style("bottom", "-100%")
                            .style("opacity", 50)
                            .style("width", 20 +"px")
                            .style("height",
                                  Math.floor(
                                    d.properties["2010"]["asian-filipino"] / 1000) + "px");
            //korean
            korbar.html("KOR")
                            .style("left", (d3.event.pageX) + 180 + "px")
                            .style("bottom", "-100%")
                            .style("opacity", 50)
                            .style("width", 20 +"px")
                            .style("height",
                                  Math.floor(
                                    d.properties["2010"]["asian-korean"] / 1000) + "px");
            
            //pacific islanders
            pacbar.html("PAC")
                            .style("left", (d3.event.pageX) + 210 + "px")
                            .style("bottom", "-100%")
                            .style("opacity", 50)
                            .style("width", 20 +"px")
                            .style("height",
                                  Math.floor(
                                    d.properties["2010"]["native-hawaiian-and-pacific-islanders"] / 1000) + "px");
            //other
            othbar.html("OTH")
                            .style("left", (d3.event.pageX) + 240 + "px")
                            .style("bottom", "-100%")
                            .style("opacity", 50)
                            .style("width", 20 +"px")
                            .style("height",
                                  Math.floor(
                                    d.properties["2010"]["other-single-race"] / 1000) + "px");
            
            //two or more
            twobar.html("TWO")
                            .style("left", (d3.event.pageX) + 270 + "px")
                            .style("bottom", "-100%")
                            .style("opacity", 50)
                            .style("width", 20 +"px")
                            .style("height",
                                  Math.floor(
                                    d.properties["2010"]["two-or-more-races"] /1000) + "px");
        }
    }
      
</script>
</html>