<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>D3 Map</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<style>
    .background{
        fill: #eee;
    }
    .map-layer {
/*        fill: black;*/
        stroke: black;
    }
    div.tooltip {	
        position: absolute;			
        text-align: center;			
        width: 100px;					
        height: 50px;					
        padding: 1px;				
        font: 20px sans-serif;		
        background: lightsteelblue;			
        border-radius: 8px;			
        pointer-events: none;
        opacity: 0;
    }
</style>
<body>
</body>
<script>
    var countryInfo = {};
    
    var div = d3.select("body")
                .append("div")
                .attr("class", "tooltip");
    
    var width = 1600,
        height = 1600;
    
    var svg = d3.select("body")
                .append("svg")
                .attr("width", width)
                .attr("height", height);
    svg.append("rect")
        .attr("class", "background")
        .attr("width", width)
        .attr("height", height);

    var g = svg.append("g");
    
    var mapLayer = g.append("g")
                    .classed("map-layer", true);
    var color = d3.scaleLog()
      .domain([1, 255])
      .range([d3.rgb(0,255,255), d3.rgb(255,0,0)]);
    
    d3.csv("population_parsed.csv", function(error, data){
        if (error){return console.error(error);}
        var max_pop = d3.max(data, function(d){return +d["Value"]})
        var min_pop = d3.min(data, function(d){return +d["Value"]})

        data.forEach(function(d, i){
            var country = d["Country Code"]
            countryInfo[country] = {};
            countryInfo[country]["population"]=d["Value"];
            countryInfo[country]["year"]=d["Year"];
        })
        color.domain([min_pop,max_pop]);
        var y = d3.scaleLinear()
        .domain([min_pop,max_pop])
        .range([0,300]);


        var defs = svg.append("defs");
        var linearGradient = defs.append("linearGradient")
        .attr("id", "linear-gradient");


        //https://www.visualcinnamon.com/2016/05/smooth-color-legend-d3-svg-gradient.html
        linearGradient.append("stop") 
        .attr("offset", "0%")   
        .attr("stop-color", color(min_pop)); 
        linearGradient.append("stop") 
        .attr("offset", "100%")   
        .attr("stop-color", color(max_pop));
        svg.append("rect")
        .attr("width", width)
        .attr("height", 120)
        .style("fill", "url(#linear-gradient)");
        var xScale = d3.scaleLinear()
                         .domain([min_pop, max_pop])
                         .range([0,width]);

        var xAxis = d3.axisBottom()
                        .scale(xScale)
                        .ticks(20)
                        .tickFormat(d3.format("d"));

        svg.append("g")
             .attr("class", "axis")
             .attr("transform", "translate(0," + 120 + ")")
             .call(xAxis);

    });

    d3.json("countries.geo.json", function(error, world){
        if (error) return console.error(error);
        
        var center = d3.geoCentroid(world);

        var projection = d3.geoMercator()
                        .scale(200)
                        .center(center)
                        .translate([width/2, height/2]);
        
        var path = d3.geoPath()
                    .projection(projection);
        
        mapLayer.selectAll("path")
                .data(world.features)
                .enter()
                .append("path")
                .attr("d", path)
                .attr('vector-effect', 'non-scaling-stroke')
                .style("fill", function(d){
                    // console.log(d.id);
                    // if(countryInfo[d.id]){
                    // console.log(countryInfo[d.id]["population"])}
                    if(countryInfo[d.id]){
//                        console.log(countryInfo[d.id]["population"]);
                    return color(countryInfo[d.id]["population"]);
                    }
                    else{return color(0);}
                })
                .on("click",mouseClick);
        
    });
    // console.log(countryInfo)
    // console.log(countryInfo["ATA"]["population"])
    function mouseClick(d){
        div.html(d.id + "\n" + countryInfo[d.id]['population'] + "<br />")
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY) + "px")
                        .style("opacity", 100); 
    }
    
</script>
</html>